---
title: 添加到现有仓库
description: 学习如何在现有的单包或多包仓库中增量采用 Turborepo 来加速开发和 CI 工作流程。
---

Turborepo 可以在**任何仓库（单包或多包）**中增量采用，以加速仓库的开发和 CI 工作流程。

在安装 `turbo` 并在 `turbo.json` 中配置任务后，你会发现[缓存](/docs/crafting-your-repository/caching)如何帮助你更快地运行任务。

## 准备单包工作区

[单包工作区](https://vercel.com/docs/vercel-platform/glossary#single-package-workspace)是指，例如，运行 `npx create-next-app` 或 `npm create vite` 后得到的结果。你不需要为 Turborepo 处理你的仓库做任何额外的工作，所以你可以直接跳到下面的第一步。

要了解更多关于 Turborepo 在单包工作区中的使用，请访问[专门的指南](/docs/guides/single-package-workspaces)。

## 准备多包工作区（monorepo）

`turbo` 建立在工作区（Workspaces）之上，这是 JavaScript 生态系统中主要包管理器的一个功能。这使得在现有代码库中采用它变得容易。

::alert{type="info"}
如果你发现 `turbo` 遇到问题，比如无法发现工作区中的包或不遵循依赖图，
请访问我们的[构建仓库](/docs/crafting-your-repository/structuring-a-repository)页面
获取提示。
::

请注意，你不必立即开始使用 `turbo` 为_所有_包运行_所有_任务。你可以从几个包中的单个任务开始，随着对 Turborepo 的熟悉程度增加，逐步添加更多任务和包。

## 将 Turborepo 添加到你的仓库

### 1. 安装 `turbo`

我们建议你同时在全局和仓库根目录中安装 `turbo`，以获得最佳的开发体验。

::code-group

```bash [pnpm]
# 在开始安装之前，请确保你已经创建了 pnpm-workspace.yaml 文件
# 如果没有此文件，将导致错误：--workspace-root may only be used inside a workspace

# 全局安装
pnpm add turbo --global
# 在仓库中安装
pnpm add turbo --save-dev --workspace-root
```

```bash [yarn]
# 全局安装
yarn global add turbo
# 在仓库中安装
yarn add turbo --dev
```

```bash [npm]
# 全局安装
npm install turbo --global
# 在仓库中安装
npm install turbo --save-dev
```

```bash [bun]
# 全局安装
bun install turbo --global
# 在仓库中安装
bun install turbo --dev
```

::

要了解更多关于我们为什么推荐两种安装方式的信息，请访问[安装页面](/docs/getting-started/installation)。

### 2. 添加 `turbo.json` 文件

在你的仓库根目录中，创建一个 `turbo.json` 文件。

在本指南中我们将使用 `build` 和 `check-types` 任务，但你可以将这些替换为你感兴趣的其他任务，如 `lint` 或 `test`。

::code-group

```json [Next.js - turbo.json]
{
  "$schema": "https://turborepo.com/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**"]
    },
    "check-types": {
      "dependsOn": ["^check-types"]
    },
    "dev": {
      "persistent": true,
      "cache": false
    }
  }
}
```

```json [Vite - turbo.json]
{
  "$schema": "https://turborepo.com/schema.json",
  "tasks": {
    "build": {
      "outputs": ["dist/**"]
    },
    "check-types": {
      "dependsOn": ["^check-types"]
    },
    "dev": {
      "persistent": true,
      "cache": false
    }
  }
}
```

::

有关配置 `turbo.json` 的更多信息，请参阅[配置选项](/docs/reference/configuration)文档。

**Next.js 配置：**

在你的 Next.js 应用程序中，确保你有一个 `check-types` 脚本供 `turbo` 运行。

```diff title="apps/web/package.json"
{
  "scripts": {
+   "check-types": "tsc --noEmit"
  }
}
```

**Vite 配置：**

一些 Vite 启动器附带的 `package.json` 看起来像这样：

```json title="package.json"
{
  "scripts": {
    "build": "tsc && vite build"
  }
}
```

我们建议将这些拆分为 `check-types` 和 `build` 脚本，以便 `turbo` 可以并行运行它们。

```json title="apps/web/package.json"
{
  "scripts": {
    "build": "vite build",
    "check-types": "tsc --noEmit"
  }
}
```

在多包工作区中，你可能还想在一个或多个库包中添加 `check-types` 脚本，
以查看如何使用一个 `turbo` 命令运行不同包中的多个脚本。

### 3. 编辑 `.gitignore`

将 `.turbo` 添加到你的 `.gitignore` 文件中。`turbo` CLI 使用这些文件夹来持久化日志、输出和其他功能。

```diff title=".gitignore"
+ .turbo
```

### 4. 在根目录 `package.json` 中添加 `packageManager` 字段

Turborepo 使用来自包管理器的信息来优化你的仓库。要声明你正在使用哪个包管理器，如果你还没有的话，请在根目录 `package.json` 中添加一个 [`packageManager`](https://nodejs.org/api/packages.html#packagemanager) 字段。

::code-group

```diff [pnpm]
{
+  "packageManager": "pnpm@10.0.0"
}
```

```diff [yarn]
{
+  "packageManager": "yarn@1.22.19"
}
```

```diff [npm]
{
+  "packageManager": "npm@8.5.0"
}
```

```diff [bun]
{
+  "packageManager": "bun@1.2.0"
}
```

::

::alert{type="info"}
根据你的仓库情况，在迁移过程中或在无法使用 `packageManager` 键的情况下，
你可能需要使用
[`dangerouslyDisablePackageManagerCheck`](/docs/reference/configuration#dangerouslydisablepackagemanagercheck)。
::

### 5. 设置包管理器工作区

对于[多包工作区](https://vercel.com/docs/glossary#multi-package-workspace)，你需要配置包管理器以识别你的工作区结构。

`workspaces` 字段告诉包管理器哪些目录包含你的包。常见的模式包括用于应用程序的 `apps/*` 和用于共享库的 `packages/*`。

::alert{type="info"}
如果你使用的是单包仓库，可以跳过此步骤，因为不需要工作区。
::

::code-group

```yaml [pnpm-workspace.yaml]
packages:
  - "apps/*"
  - "packages/*"
```

```json [package.json (yarn)]
{
  "workspaces": [
    "apps/*",
    "packages/*"
  ]
}
```

```json [package.json (npm)]
{
  "workspaces": [
    "apps/*",
    "packages/*"
  ]
}
```

```json [package.json (bun)]
{
  "workspaces": [
    "apps/*",
    "packages/*"
  ]
}
```

::

**参考文档：**
- [pnpm workspace 文档](https://pnpm.io/pnpm-workspace_yaml)
- [yarn workspace 文档](https://yarnpkg.com/features/workspaces#how-are-workspaces-declared)
- [npm workspace 文档](https://docs.npmjs.com/cli/v7/using-npm/workspaces#defining-workspaces)
- [bun workspace 文档](https://bun.sh/docs/install/workspaces)

有关如何构建仓库的更多详细信息，请参阅[构建仓库](/docs/crafting-your-repository/structuring-a-repository#declaring-directories-for-packages)。

### 6. 使用 `turbo` 运行任务

现在你可以使用 Turborepo 运行之前添加到 `turbo.json` 中的任务。使用上面的示例任务：

```bash title="Terminal"
turbo build check-types
```
这会同时运行 `build` 和 `check-types` 任务。你的[工作区](/docs/crafting-your-repository/structuring-a-repository#anatomy-of-a-workspace)的依赖图将用于按正确的顺序运行任务。

### 7. 开始开发

现在你可以开始开发你的应用程序和包了。如果你的 `package.json` 中有 `dev` 脚本，你可以使用以下命令运行它：

```bash title="Terminal"
turbo dev
```

这将在所有具有 `dev` 脚本的包中运行该脚本。你也可以为特定包运行 `dev` 脚本：

```bash title="Terminal"
turbo dev --filter=web
```

有关过滤的更多信息，请参阅[过滤](/docs/core-concepts/monorepos/filtering)文档。

::alert{type="info"}
请注意，此步骤在单包工作区中没有太大价值，因为：

- 你不会缓存开发任务的输出。
- 只有一个开发脚本，所以没有什么可以并行运行的。
::

## 后续步骤

你已经成功将 Turborepo 添加到你的仓库中！以下是一些后续步骤，帮助你充分利用 Turborepo：

- [了解缓存以加速你的任务](/docs/core-concepts/caching)
- [设置远程缓存以在机器之间和团队中共享缓存工件](/docs/core-concepts/remote-caching)
- [了解更多关于运行任务的信息](/docs/crafting-your-repository/running-tasks)
